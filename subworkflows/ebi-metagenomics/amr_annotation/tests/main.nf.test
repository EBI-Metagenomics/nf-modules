nextflow_workflow {

    name "Test Subworkflow AMR_ANNOTATION"
    script "../main.nf"
    workflow "AMR_ANNOTATION"
    config "./nextflow.config"

    tag "subworkflows"
    tag "subworkflows_ebimetagenomics"
    tag "subworkflows/amr_annotation"
    tag "amrintegrator"
    tag "nf-core/amrfinderplus"
    tag "nf-core/amrfinderplus/update"
    tag "nf-core/amrfinderplus/run"
    tag "nf-core/deeparg"
    tag "nf-core/deeparg/predict"
    tag "nf-core/rgi"
    tag "nf-core/rgi/cardannotation"
    tag "nf-core/rgi/main"
    tag "nf-core/wget/main"
    tag "nf-core/untar"
    tag "nf-core/unzip"
    tag "nf-core/hamronization"
    tag "nf-core/hamronization/rgi"
    tag "nf-core/hamronization/deeparg"

    setup {
        nfcoreInitialise("${launchDir}/library/")
        nfcoreInstall(
            "${launchDir}/library/",
            [
                "amrfinderplus/update",
                "amrfinderplus/run",
                "deeparg/predict",
                "rgi/cardannotation",
                "rgi/main",
                "wget",
                "untar",
                "unzip",
                "hamronization/rgi",
                "hamronization/deeparg"
            ]
        )
        nfcoreLink("${launchDir}/library/", "${baseDir}/modules/")
    }

    test("detect_amr - amrfinderplus") {
        when {
            params {
                arg_amrfinderplus_db   = null
                arg_skip_amrfinderplus = false 
                arg_skip_rgi           = true
                arg_skip_deeparg       = true
            }

            workflow {
                """
                input[0] = Channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/pos_minitest.faa', checkIfExists: true),
                    file('${moduleDir}/tests/data/minitest.gff', checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(workflow.out).match()}
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("detect_amr - rgi") {
        when {
            params {
                arg_rgi_db             = null
                arg_skip_amrfinderplus = true
                arg_skip_rgi           = false
                arg_skip_deeparg       = true
            }

            workflow {
                """
                input[0] = Channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/pos_minitest.faa', checkIfExists: true),
                    file('${moduleDir}/tests/data/minitest.gff', checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(workflow.out).match()}
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("detect_amr - deeparg") {
        when {
            params {
                arg_deeparg_db         = "${moduleDir}/tests/databases/minideeparg/db"
                arg_deeparg_model      = "LS"
                arg_deeparg_db_version = "2"
                arg_skip_amrfinderplus = true
                arg_skip_rgi           = true
                arg_skip_deeparg       = false
            }

            workflow {
                """
                input[0] = Channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/pos_minitest.faa', checkIfExists: true),
                    file('${moduleDir}/tests/data/minitest.gff', checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(workflow.out).match()}
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("detect_amr - no prediction") {
        when {
            params {
                arg_skip_amrfinderplus = true
                arg_skip_rgi           = true
                arg_skip_deeparg       = true
            }

            workflow {
                """
                input[0] = Channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/pos_minitest.faa', checkIfExists: true),
                    file('${moduleDir}/tests/data/minitest.gff', checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(workflow.out).match()}
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }

    test("detect_amr - all tools - no matches") {
        when {
            params {
                arg_amrfinderplus_db   = null
                arg_rgi_db             = null
                arg_deeparg_db         = "${moduleDir}/tests/databases/minideeparg/db"
                arg_deeparg_model      = "LS"
                arg_deeparg_db_version = "2"

                arg_skip_amrfinderplus = false
                arg_skip_rgi           = false
                arg_skip_deeparg       = false
            }

            workflow {
                """
                input[0] = Channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/neg_minitest.faa', checkIfExists: true),
                    file('${moduleDir}/tests/data/minitest.gff', checkIfExists: true)
                ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
               { assert snapshot(
                    workflow.out,
                    workflow.out.versions.collect{ path(it).yaml }.unique()
                ).match() }
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
        }
    }
}
