nextflow_workflow {

    name "Test Subworkflow BGC_INTEGRATOR"
    script "../main.nf"
    workflow "BGC_INTEGRATOR"

    tag "subworkflows"
    tag "subworkflows_ebimetagenomics"
    tag "subworkflows/bgc_integrator"
    tag "gff2gbk"
    tag "antismashgffbuilder"
    tag "sanntis"
    tag "bgcmapper"
    tag "interproscan"
    tag "nf-core/antismash/antismash"
    tag "nf-core/antismash/antismashdownloaddatabases"
    tag "nf-core/gecco/run"
    tag "nf-core/gecco/convert"
    tag "nf-core/aria2"
    tag "nf-core/untar"

    setup {
        nfcoreInitialise("${launchDir}/library/")
        nfcoreInstall(
            "${launchDir}/library/",
            [
                "antismash/antismash",
                "antismash/antismashdownloaddatabases",
                "gecco/run",
                "gecco/convert",
                "aria2",
                "untar",
            ]
        )
        nfcoreLink("${launchDir}/library/", "${baseDir}/modules/")
    }

    test("positive test - contigs, gff, proteins, ips - sanntis") {

        when {
            workflow {
                """
                input[0] = channel.of( [ [ id:'test' ], // meta map
                    file('${moduleDir}/tests/data/test.fasta.gz', checkIfExists: true),
                    file('${moduleDir}/tests/data/test.gff.gz', checkIfExists: true),
                    file('${moduleDir}/tests/data/test.faa.gz', checkIfExists: true),
                    file('${moduleDir}/tests/data/test_ips.tsv.gz', checkIfExists: true),
                ])
                input[1] = null      // ch_antismash_db
                input[2] = null      // ch_ips_db
                input[3] = null      // interproscan_db_url
                input[4] = false     // skip_sanntis
                input[5] = true      // skip_gecco
                input[6] = true      // skip_antismash
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success},
                { assert snapshot(workflow.out).match()}
            )
        }

        cleanup {
            nfcoreUnlink("${launchDir}/library/", "${baseDir}/modules/nf-core")
            nfcoreDeleteLibrary("${baseDir}/modules/nf-core")
        }
    }
}
